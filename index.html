<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ultimate Investor Dashboard ‚Ä¢ 15.02.2026</title>

<!-- ECharts + WebGL -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>

<style>
  :root{
    --bg:#070b18;
    --card:#0f1730;
    --card2:#0a1124;
    --line:#1f2a4d;
    --text:#eef1ff;
    --muted:#9aa4d4;
    --ok:#2dd4bf;
    --warn:#fbbf24;
    --bad:#fb7185;
    --accent:#60a5fa;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background: radial-gradient(1200px 700px at 15% 0%, #2a1b3d 0%, #18224a 18%, var(--bg) 55%);
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    line-height:1.35;
  }
  .wrap{max-width:1480px;margin:0 auto;padding:28px 18px 46px}
  header{
    display:flex;gap:14px;align-items:stretch;justify-content:space-between;flex-wrap:wrap
  }
  .hero{
    flex:1;
    padding:18px 18px;
    border:1px solid rgba(251,113,133,.40);
    background:linear-gradient(180deg, rgba(251,113,133,.18), rgba(15,23,48,.78));
    border-radius:22px;
    box-shadow:0 18px 40px rgba(0,0,0,.35);
    min-width: 320px;
  }
  h1{margin:0;font-size:28px;letter-spacing:.2px}
  .sub{margin-top:8px;color:var(--muted);font-size:14px}
  .pillrow{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
  .pill{
    display:inline-flex;gap:8px;align-items:center;
    padding:9px 12px;border-radius:999px;
    border:1px solid var(--line);
    background:rgba(15,23,48,.65);
    color:var(--muted);
    font-size:13px;
  }
  .pill b{color:var(--text)}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .dot.ok{background:var(--ok)}
  .dot.warn{background:var(--warn)}
  .dot.bad{background:var(--bad)}
  .panel{
    width: 440px;
    padding:14px;
    border:1px solid var(--line);
    border-radius:18px;
    background:rgba(15,23,48,.62);
    box-shadow:0 14px 28px rgba(0,0,0,.22);
    min-width: 320px;
  }
  .lead{margin:0 0 8px;font-size:15px}
  .muted{color:var(--muted)}
  .grid{display:grid;gap:14px}
  .kpis{grid-template-columns: repeat(12, 1fr); margin-top:14px}
  .card{
    grid-column:span 3;
    padding:14px 14px;
    border-radius:18px;
    border:1px solid var(--line);
    background:rgba(17,26,51,.72);
    box-shadow:0 10px 22px rgba(0,0,0,.22);
  }
  .card h3{
    margin:0 0 6px;
    font-size:12px;
    color:var(--muted);
    font-weight:800;
    letter-spacing:.6px;
    text-transform:uppercase;
  }
  .big{font-size:22px;font-weight:900}
  .hint{margin-top:6px;color:var(--muted);font-size:12px}
  .tabs{
    margin-top:14px;
    display:flex;gap:10px;flex-wrap:wrap;
  }
  .tab{
    cursor:pointer;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(17,26,51,.80);
    color:var(--text);
    font-weight:900;
  }
  .tab.active{outline:2px solid rgba(96,165,250,.65)}
  .section{
    margin-top:18px;
    padding:18px;
    border-radius:22px;
    border:1px solid var(--line);
    background:linear-gradient(180deg, rgba(17,26,51,.70), rgba(15,23,48,.70));
  }
  .section h2{margin:0 0 10px;font-size:18px}
  .cols{display:grid;grid-template-columns: 1fr 1fr;gap:14px}
  .chart{
    height:520px;
    border-radius:20px;
    background:linear-gradient(145deg,var(--card),var(--card2));
    border:1px solid var(--line);
    box-shadow:0 22px 46px rgba(0,0,0,.38);
    padding:10px;
  }
  .chart.small{height:380px}
  .chart.tall{height:620px}
  .note{color:var(--muted);font-size:12px;margin-top:10px}
  .flags{display:grid;gap:10px}
  .flag{
    padding:12px 12px;
    border-radius:16px;
    border:1px solid rgba(251,113,133,.35);
    background:rgba(251,113,133,.08);
  }
  .flag.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.08)}
  .flag.ok{border-color:rgba(45,212,191,.35);background:rgba(45,212,191,.07)}
  .flag b{color:var(--text)}
  .meta{color:var(--muted);font-size:12px;margin-top:6px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{
    cursor:pointer;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(17,26,51,.80);
    color:var(--text);
    font-weight:900;
  }
  .btn.active{outline:2px solid rgba(251,113,133,.62)}
  .spacer{height:2px;background:rgba(31,42,77,.65);border-radius:999px;margin:10px 0}
  .footer{margin-top:14px;color:var(--muted);font-size:12px}
  a.link{color:var(--accent);text-decoration:none;font-weight:800}
  @media (max-width: 1100px){
    .card{grid-column:span 6}
    .cols{grid-template-columns:1fr}
    .panel{width:auto}
    .chart{height:460px}
    .chart.small{height:360px}
  }
</style>
</head>

<body>
<div class="wrap">

<header>
  <div class="hero">
    <h1>üö® Ultimate Investor Dashboard ‚Ä¢ 15.02.2026</h1>
    <div class="sub">PE-grade Crisis Dashboard: –∫–æ–Ω—Ç—Ä–æ–ª—å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, –±–∞–Ω–∫–∞, —Å—Ç—Ä–æ–π–∫–∏ –∏ –∫–æ–º–∞–Ω–¥—ã. WebGL 3D. –í—Å—ë –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ.</div>

    <div class="pillrow">
      <span class="pill"><span class="dot bad"></span> –°—Ç–∞—Ç—É—Å: <b style="color:var(--bad)">–∫—Ä–∏—Ç–∏—á–Ω–æ</b> (–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ–º–æ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞)</span>
      <span class="pill">–î–µ–¥–ª–∞–π–Ω –∞–Ω—Ç–∏–∫—Ä–∏–∑–∏—Å–∞: <b id="deadlineText">‚Äî</b></span>
      <span class="pill">–¢–∞–π–º–µ—Ä: <b id="countdown">‚Äî</b></span>
    </div>

    <div class="tabs">
      <button class="tab active" data-view="overview">Overview</button>
      <button class="tab" data-view="capital">Capital & Debt</button>
      <button class="tab" data-view="risk">Risk & Control</button>
      <button class="tab" data-view="sensitivity">Sensitivity Lab</button>
      <button class="tab" data-view="action">30-Day Action Plan</button>
    </div>
  </div>

  <div class="panel">
    <div class="lead"><b>–°—Ü–µ–Ω–∞—Ä–∏–∏</b></div>
    <div class="muted">–ü–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ: KPI, –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –∏–Ω–¥–µ–∫—Å —É–≥—Ä–æ–∑—ã –ø–µ—Ä–µ—Å—á–∏—Ç–∞—é—Ç—Å—è —Å—Ä–∞–∑—É.</div>
    <div class="spacer"></div>
    <div class="controls">
      <button class="btn active" data-scn="base">–°–µ–π—á–∞—Å</button>
      <button class="btn" data-scn="turnaround">–ê–Ω—Ç–∏–∫—Ä–∏–∑–∏—Å 30 –¥–Ω–µ–π</button>
      <button class="btn" data-scn="drift">–ò–Ω–µ—Ä—Ü–∏—è</button>
      <button class="btn" data-scn="stress">–°—Ç—Ä–µ—Å—Å</button>
    </div>
    <div class="spacer"></div>
    <div class="lead" style="margin-top:6px"><b>–≠–∫—Å–ø–æ—Ä—Ç</b></div>
    <div class="muted">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ JSON –¥–ª—è –∞—É–¥–∏—Ç–∞/–±–∞–Ω–∫–∞.</div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="exportJson">‚¨á Export JSON</button>
      <button class="btn" id="autoPlay">‚ñ∂ Auto-play —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤</button>
    </div>
    <div class="footer">
      –ü–æ–¥ GitHub Pages: –ø—Ä–æ—Å—Ç–æ `index.html` + –≤–∫–ª—é—á–∏—Ç—å Pages.
    </div>
  </div>
</header>

<!-- KPI row -->
<div class="grid kpis" id="kpiRow"></div>

<!-- Views -->
<section class="section" id="view-overview">
  <h2>Overview: –≥–¥–µ –±–æ–ª–∏—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</h2>
  <div class="cols">
    <div class="panel">
      <div class="lead"><b>–ö—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏ (—Ä–µ–∞–ª—å–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–∞)</b></div>
      <div class="flags" id="flags"></div>
      <div class="note">
        –§–æ–∫—É—Å –∏–Ω–≤–µ—Å—Ç—Ñ–æ–Ω–¥–∞: –Ω–µ ‚Äú–ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å‚Äù, –∞ <b>–∫–æ–Ω—Ç—Ä–æ–ª—å –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –¥–µ–Ω–µ–≥ ‚Üí –±–µ—Ç–æ–Ω</b> –∏ <b>—É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å cash runway</b>.
      </div>
    </div>

    <div class="chart small" id="gaugeThreat"></div>
  </div>

  <div class="cols" style="margin-top:14px">
    <div class="chart" id="debt3d"></div>
    <div class="chart" id="waterfall3d"></div>
  </div>
</section>

<section class="section" id="view-capital" style="display:none">
  <h2>Capital & Debt: –ø–∏—Ä–∞–º–∏–¥–∞ –¥–æ–ª–≥–∞ –∏ –≥–¥–µ ‚Äú–ø—Ä–æ—Ç–µ—á–∫–∞‚Äù</h2>
  <div class="cols">
    <div class="chart" id="pfUsage3d"></div>
    <div class="chart" id="pfSpend3d"></div>
  </div>
  <div class="cols" style="margin-top:14px">
    <div class="chart" id="escrow3d"></div>
    <div class="chart" id="sales3d"></div>
  </div>
</section>

<section class="section" id="view-risk" style="display:none">
  <h2>Risk & Control: –º–∞—Ç—Ä–∏—Ü–∞ —Ä–∏—Å–∫–æ–≤, radar, –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h2>
  <div class="cols">
    <div class="chart" id="riskHeat3d"></div>
    <div class="chart" id="riskRadar"></div>
  </div>
  <div class="cols" style="margin-top:14px">
    <div class="chart" id="ready3d"></div>
    <div class="chart" id="timeline"></div>
  </div>
</section>

<section class="section" id="view-sensitivity" style="display:none">
  <h2>Sensitivity Lab: DSCR / NPV proxy surface (3D) + LTV matrix (3D)</h2>
  <div class="cols">
    <div class="chart tall" id="dscrSurface"></div>
    <div class="chart tall" id="ltvSurface"></div>
  </div>
  <div class="note">
    –≠—Ç–æ –Ω–µ ‚Äú–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ‚Äù, –∞ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏—Ö —Ä–µ—à–µ–Ω–∏–π: –≥–¥–µ —Ç–æ–Ω–∫–æ ‚Äî —Ç–∞–º –∏ —Ä–µ–∂–µ–º —Ä–∏—Å–∫ (—Ü–µ–Ω–∞/—Ç–µ–º–ø/—Ä–∞—Å—Ö–æ–¥/–ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã —Å –±–∞–Ω–∫–æ–º).
  </div>
</section>

<section class="section" id="view-action" style="display:none">
  <h2>30-Day Action Plan: –ø–ª–∞–Ω –∫–∞–∫ —É —Ñ–æ–Ω–¥–∞ (–Ω–µ –∫–∞–∫ —É ‚Äú—Å—Ç—Ä–æ–∏—Ç–µ–ª–µ–π‚Äù)</h2>
  <div class="panel">
    <div class="lead"><b>–ù–µ–¥–µ–ª—è 1 (0‚Äì7 –¥–Ω–µ–π): –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ</b></div>
    <ol class="muted" style="margin:0;padding-left:18px">
      <li>–ï–¥–∏–Ω—ã–π –∫–æ–º–∞–Ω–¥–Ω—ã–π —Ü–µ–Ω—Ç—Ä: <b>–∞–Ω—Ç–∏–∫—Ä–∏–∑–∏—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å —Å—Ç—Ä–æ–π–∫–∏</b> + —Ñ–∏–Ω–∫–æ–Ω—Ç—Ä–æ–ª—å, –ø–æ–ª–Ω–æ–º–æ—á–∏—è ‚Äústop/approve‚Äù.</li>
      <li>13-–Ω–µ–¥–µ–ª—å–Ω—ã–π –î–î–°: –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è, –ø–ª–∞—Ç–µ–∂–Ω—ã–π –∫–æ–º–∏—Ç–µ—Ç, –ª–∏–º–∏—Ç—ã –Ω–∞ —Å—Ç–∞—Ç—å–∏.</li>
      <li>–¢–û–ü-10 –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤: ‚Äú–º–æ—Ä–∞—Ç–æ—Ä–∏–π‚Äù + –≥—Ä–∞—Ñ–∏–∫ –≤—ã–ø–ª–∞—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç-1 (–∏–Ω–∞—á–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–±–æ—Ç).</li>
      <li>–ü–∞–∫–µ—Ç –≤ –±–∞–Ω–∫: —Ñ–∞–∫—Ç-–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å, –∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤–æ–∑–≤—Ä–∞—Ç —Ü–µ–ª–µ–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.</li>
      <li>–ö–æ–º–∞–Ω–¥–∞: –≥—Ä–∞—Ñ–∏–∫ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –≤—ã–ø–ª–∞—Ç + –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π (–∏–Ω–∞—á–µ —Ä–∞—Å–ø–∞–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è).</li>
    </ol>

    <div class="spacer"></div>
    <div class="lead"><b>–ù–µ–¥–µ–ª—è 2‚Äì4 (8‚Äì30 –¥–Ω–µ–π): –≤–µ—Ä–Ω—É—Ç—å –¥–æ–≤–µ—Ä–∏–µ –±–∞–Ω–∫—É –∏ —É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å</b></div>
    <ol class="muted" style="margin:0;padding-left:18px">
      <li>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π ‚Äú–±–µ—Ç–æ–Ω-—Ä–µ–ø–æ—Ä—Ç‚Äù: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å, –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, –ø—Ä–∏—á–∏–Ω—ã, —Ä–µ—à–µ–Ω–∏—è.</li>
      <li>–ü–ª–∞–Ω ‚Äú+3‚Äì5% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏‚Äù –≤ 30 –¥–Ω–µ–π: —Ä–∞–∑—Ä–µ–∑ –ø–æ –¥–æ–º–∞–º/—Å–µ–∫—Ü–∏—è–º/–≤–µ—Ö–∞–º.</li>
      <li>–†–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è –∫—Ä–µ–¥–∏—Ç–æ—Ä–∫–∏: –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–∞—Å—Ç–∏ –≤ —ç—Ç–∞–ø–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏, –≤–∑–∞–∏–º–æ–∑–∞—á–µ—Ç—ã, –Ω–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è.</li>
      <li>–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –±–ª–æ–∫: –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–¥–∞–∂ (–∏–ø–æ—Ç–µ–∫–∞/—Å—É–±—Å–∏–¥–∏—è/–¥–∏—Å–∫–æ–Ω—Ç –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –æ–ø–ª–∞—Ç—ã).</li>
      <li>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—É—Ä: –∑–∞—â–∏—Ç–∞ –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤/—Ç–µ—Ö–∑–∞–∫–∞–∑—á–∏–∫–∞, –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª—å.</li>
    </ol>

    <div class="footer">
      –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ ‚Äî —è –ø—Ä–µ–≤—Ä–∞—â—É —ç—Ç–æ—Ç –ø–ª–∞–Ω –≤ ‚Äú—á–µ–∫-–ª–∏—Å—Ç‚Äù –Ω–∞ –Ω–µ–¥–µ–ª—é (—Ç–∞–±–ª–∏—Ü–∞ + RACI + –¥–µ–¥–ª–∞–π–Ω—ã).
    </div>
  </div>
</section>

</div>

<script>
/* =========================================================
   DATA LAYER (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ backend/json –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏)
   ========================================================= */

const BASE = {
  meta: {
    reportDate: "2026-02-15",
    deadlineDate: "2026-03-16T23:59:59+03:00", // 30 –¥–Ω–µ–π –æ—Ç 15.02, –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å
    currency: "RUB",
  },
  kpi: {
    cash_mln: 1.59,
    ap_total_mln: 119.4,
    ap_p1_mln: 77.1,
    ap_p2_mln: 12.4,
    ap_p3_mln: 29.9,
    debt_total_mln: 1175.0,
    pf_limit_mln: 1055.8,
    pf_drawn_mln: 863.6,
    pf_undrawn_mln: 192.2,
    pf_misuse_mln: 190.4,
    pf_cmr_mln: 459.3,
    pf_admin_mln: 213.9,
    pf_divert_mln: 190.4,
    escrow_total_mln: 839.0,
    ready_mol_pct: 32.5,
    ready_don_pct: 27.5,
    // portfolio sales (m2)
    projects: [
      {name:"–ñ–ö –ú–æ–ª–æ–¥—ë–∂–Ω—ã–π", sold_m2: 3732, remain_m2: 1385, contracts_mln: 475.5, escrow_mln: 452.8},
      {name:"–ñ–ö –î–æ–Ω–µ—Ü–∫–∏–π",   sold_m2: 2960, remain_m2: 1335, contracts_mln: 460.9, escrow_mln: 385.9},
    ]
  }
};

// —Å—Ü–µ–Ω–∞—Ä–∏–∏: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã/–∏–∑–º–µ–Ω–µ–Ω–∏—è (—É–ø—Ä–æ—â–µ–Ω–Ω–æ, –Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏ –ø–æ–ª–µ–∑–Ω–æ)
const SCENARIOS = {
  base: {
    name: "–°–µ–π—á–∞—Å",
    cashMult: 1.0,
    apMult: 1.0,
    pfAccess: "–∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ",
    readyAdd: 0.0,
    threatBase: 82
  },
  turnaround: {
    name: "–ê–Ω—Ç–∏–∫—Ä–∏–∑–∏—Å 30 –¥–Ω–µ–π",
    cashOverride: 10.0,
    apReduceP1: 0.40,     // –ø–æ–≥–∞—à–∞–µ–º 40% –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ 1
    pfAccess: "—Ä–∞–∑–º–æ—Ä–æ–∂–µ–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ",
    readyAdd: 4.0,        // +4 –ø.–ø. –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    threatBase: 48
  },
  drift: {
    name: "–ò–Ω–µ—Ä—Ü–∏—è",
    cashOverride: 0.5,
    apMult: 1.25,
    pfAccess: "–∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ",
    readyAdd: -1.0,
    threatBase: 92
  },
  stress: {
    name: "–°—Ç—Ä–µ—Å—Å",
    cashOverride: 0.5,
    apMult: 1.35,
    pfAccess: "–∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ",
    readyAdd: -2.0,
    threatBase: 97
  }
};

/* =========================================================
   UTILS
   ========================================================= */
const fmt = {
  mln: (x) => new Intl.NumberFormat('ru-RU',{minimumFractionDigits:1, maximumFractionDigits:1}).format(x) + ' –º–ª–Ω ‚ÇΩ',
  pct: (x) => (x).toFixed(1).replace('.', ',') + '%',
  num: (x) => new Intl.NumberFormat('ru-RU').format(x)
};

function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

function computeState(scnKey){
  const s = SCENARIOS[scnKey];
  const k = JSON.parse(JSON.stringify(BASE.kpi));

  // cash
  if (typeof s.cashOverride === "number") k.cash_mln = s.cashOverride;
  else k.cash_mln = k.cash_mln * (s.cashMult ?? 1.0);

  // ap
  k.ap_total_mln = k.ap_total_mln * (s.apMult ?? 1.0);

  if (typeof s.apReduceP1 === "number"){
    const reduce = k.ap_p1_mln * s.apReduceP1;
    k.ap_total_mln = Math.max(0, k.ap_total_mln - reduce);
    k.ap_p1_mln = Math.max(0, k.ap_p1_mln - reduce);
  }

  // readiness
  k.ready_mol_pct = clamp(k.ready_mol_pct + (s.readyAdd ?? 0), 0, 100);
  k.ready_don_pct = clamp(k.ready_don_pct + (s.readyAdd ?? 0), 0, 100);

  // threat index (0..100) ‚Äî –ø—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å: –º–µ–Ω—å—à–µ cash, –±–æ–ª—å—à–µ AP, –º–µ–Ω—å—à–µ readiness => –≤—ã—à–µ —É–≥—Ä–æ–∑–∞
  const cashScore = clamp(100 - (k.cash_mln * 6), 0, 100);            // 10 –º–ª–Ω => ~40
  const apScore   = clamp((k.ap_total_mln / 1.5), 0, 100);            // 150 –º–ª–Ω => 100
  const readyAvg  = (k.ready_mol_pct + k.ready_don_pct)/2;
  const readyScore= clamp(100 - (readyAvg * 2.2), 0, 100);            // 45% => ~1
  const pfMisuseScore = clamp((k.pf_misuse_mln / 2.0), 0, 100);        // 200 => 100

  const threat = clamp(
    0.30*cashScore + 0.28*apScore + 0.22*readyScore + 0.20*pfMisuseScore,
    0, 100
  );

  return { scenarioKey: scnKey, scenario: s, kpi: k, threat: Math.round(threat) };
}

/* =========================================================
   UI: Tabs + Scenario switching + Countdown + Export
   ========================================================= */
let current = computeState("base");
let autoplayTimer = null;

function setActiveTab(view){
  document.querySelectorAll('.tab[data-view]').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-view="${view}"]`)?.classList.add('active');

  const views = ["overview","capital","risk","sensitivity","action"];
  for(const v of views){
    document.getElementById(`view-${v}`).style.display = (v === view) ? "block" : "none";
  }
  // resize charts after tab switch
  setTimeout(resizeAll, 60);
}

document.querySelectorAll('.tab[data-view]').forEach(btn=>{
  btn.addEventListener('click', ()=> setActiveTab(btn.dataset.view));
});

function setScenario(key){
  document.querySelectorAll('.btn[data-scn]').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.btn[data-scn="${key}"]`)?.classList.add('active');

  current = computeState(key);
  renderKpis();
  renderFlags();
  renderAllCharts();
}

document.querySelectorAll('.btn[data-scn]').forEach(btn=>{
  btn.addEventListener('click', ()=> setScenario(btn.dataset.scn));
});

function startAutoPlay(){
  const order = ["base","turnaround","drift","stress"];
  let idx = order.indexOf(current.scenarioKey);
  if (idx < 0) idx = 0;

  if (autoplayTimer){
    clearInterval(autoplayTimer);
    autoplayTimer = null;
    document.getElementById('autoPlay').textContent = "‚ñ∂ Auto-play —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤";
    return;
  }
  document.getElementById('autoPlay').textContent = "‚è∏ Stop auto-play";
  autoplayTimer = setInterval(()=>{
    idx = (idx + 1) % order.length;
    setScenario(order[idx]);
  }, 3500);
}

document.getElementById('autoPlay').addEventListener('click', startAutoPlay);

function exportJSON(){
  const payload = {
    exportedAt: new Date().toISOString(),
    scenario: current.scenario,
    threat: current.threat,
    data: current.kpi
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `dashboard_${current.scenarioKey}_${BASE.meta.reportDate}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
document.getElementById('exportJson').addEventListener('click', exportJSON);

// Countdown
function tickCountdown(){
  const deadline = new Date(BASE.meta.deadlineDate);
  const now = new Date();
  const diff = deadline - now;
  const dd = Math.max(0, Math.floor(diff / (1000*60*60*24)));
  const hh = Math.max(0, Math.floor((diff % (1000*60*60*24)) / (1000*60*60)));
  const mm = Math.max(0, Math.floor((diff % (1000*60*60)) / (1000*60)));
  const ss = Math.max(0, Math.floor((diff % (1000*60)) / 1000));

  const deadTxt = `${deadline.toLocaleDateString('ru-RU')} ${deadline.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}`;
  document.getElementById('deadlineText').textContent = deadTxt;
  document.getElementById('countdown').textContent = `${dd}–¥ ${hh}—á ${mm}–º ${ss}—Å`;

  setTimeout(tickCountdown, 1000);
}
tickCountdown();

/* =========================================================
   KPI cards + Flags (investor tone)
   ========================================================= */
function renderKpis(){
  const k = current.kpi;
  const cards = [
    {t:"–û—Å—Ç–∞—Ç–æ–∫ –î–°", v: fmt.mln(k.cash_mln), h:"–¢–µ–∫—É—â–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å (cash runway)"},
    {t:"–ö—Ä–µ–¥–∏—Ç–æ—Ä–∫–∞ (–∏—Ç–æ–≥–æ)", v: fmt.mln(k.ap_total_mln), h:`–ü—Ä–∏–æ—Ä.1: ${fmt.mln(k.ap_p1_mln)}`},
    {t:"–û–±—â–∏–π –¥–æ–ª–≥", v: fmt.mln(k.debt_total_mln), h:"–ü–§ + –∫—Ä–µ–¥–∏—Ç–æ—Ä—ã"},
    {t:"–û—Å—Ç–∞—Ç–æ–∫ –ª–∏–º–∏—Ç–∞ –ü–§", v: fmt.mln(k.pf_undrawn_mln), h:`–î–æ—Å—Ç—É–ø: ${current.scenario.pfAccess}`},
    {t:"–ù–µ—Ü–µ–ª–µ–≤–æ–µ –ü–§", v: fmt.mln(k.pf_misuse_mln), h:"–°–∏–≥–Ω–∞–ª –±–∞–Ω–∫—É –æ –ø–æ—Ç–µ—Ä–µ –∫–æ–Ω—Ç—Ä–æ–ª—è"},
    {t:"–≠—Å–∫—Ä–æ—É (–Ω–∞ —Å—á–µ—Ç–∞—Ö)", v: fmt.mln(k.escrow_total_mln), h:"–ù–µ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ—Ä–æ–≥–æ–≤"},
    {t:"–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å (–ú–æ–ª.)", v: fmt.pct(k.ready_mol_pct), h:"–ü–æ—Ä–æ–≥ 30% = –∫–ª—é—á –∫ –ø–µ—Ä–≤—ã–º —Ä–∞—Å–∫—Ä—ã—Ç–∏—è–º"},
    {t:"–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å (–î–æ–Ω.)", v: fmt.pct(k.ready_don_pct), h:"–†–∏—Å–∫ –∑–∞–¥–µ—Ä–∂–∫–∏ –≤–≤–æ–¥–∞/–¥–µ–Ω–µ–≥"},
  ];

  const row = document.getElementById('kpiRow');
  row.innerHTML = "";
  for(const c of cards){
    const d = document.createElement('div');
    d.className = 'card';
    d.innerHTML = `<h3>${c.t}</h3><div class="big">${c.v}</div><div class="hint">${c.h}</div>`;
    row.appendChild(d);
  }
}

function renderFlags(){
  const k = current.kpi;
  const flags = [];

  // Cash vs P1
  if (k.cash_mln < 5) flags.push({type:'bad', title:'Cash runway –Ω–∞ –≥—Ä–∞–Ω–∏', meta:`–ù–∞ —Å—á–µ—Ç–∞—Ö ${fmt.mln(k.cash_mln)} –ø—Ä–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ-1 ${fmt.mln(k.ap_p1_mln)}.`});
  else flags.push({type:'warn', title:'–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞', meta:`–ù—É–∂–Ω–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –ø–ª–∞—Ç–µ–∂–µ–π: cash ${fmt.mln(k.cash_mln)}.`});

  // PF misuse
  if (k.pf_misuse_mln > 120) flags.push({type:'bad', title:'–î–æ–≤–µ—Ä–∏–µ –±–∞–Ω–∫–∞ —Ä–∞–∑—Ä—É—à–µ–Ω–æ', meta:`–ù–µ—Ü–µ–ª–µ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ü–§ ${fmt.mln(k.pf_misuse_mln)} ‚Äî –±–∞–Ω–∫ ‚Äú–ø–æ–≤–µ—Ä–∏—Ç —Ç–æ–ª—å–∫–æ –≤ –±–µ—Ç–æ–Ω‚Äù.`});

  // Readiness
  const avg = (k.ready_mol_pct + k.ready_don_pct)/2;
  if (avg < 30) flags.push({type:'bad', title:'–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –Ω–∏–∂–µ ‚Äú–∫–ª—é—á–∞‚Äù –∫ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è–º', meta:`–°—Ä–µ–¥–Ω—è—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å ~${fmt.pct(avg)}. –≠—Å–∫—Ä–æ—É —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω.`});
  else flags.push({type:'ok', title:'–ï—Å—Ç—å –æ–∫–Ω–æ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏–π', meta:`–°—Ä–µ–¥–Ω—è—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å ~${fmt.pct(avg)}. –£—Å–∫–æ—Ä–µ–Ω–∏–µ –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å–≥–∏.`});

  // AP pressure
  if (k.ap_total_mln > 130) flags.push({type:'bad', title:'–†–æ—Å—Ç –∫—Ä–µ–¥–∏—Ç–æ—Ä–∫–∏ —É—Å–∫–æ—Ä—è–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫—É —Ä–∞–±–æ—Ç', meta:`–ö—Ä–µ–¥–∏—Ç–æ—Ä–∫–∞ ${fmt.mln(k.ap_total_mln)}. –†–∏—Å–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤.`});
  else flags.push({type:'warn', title:'–ö—Ä–µ–¥–∏—Ç–æ—Ä–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –∫–æ–º–∏—Ç–µ—Ç–∞', meta:`–ù—É–∂–µ–Ω –ø–ª–∞—Ç–µ–∂–Ω—ã–π –∫–æ–º–∏—Ç–µ—Ç –∏ –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤.`});

  // Scenario message
  flags.push({
    type: (current.threat >= 85 ? 'bad' : current.threat >= 65 ? 'warn' : 'ok'),
    title: '–ò–Ω–¥–µ–∫—Å —É–≥—Ä–æ–∑—ã (0‚Äì100)',
    meta: `–°–µ–π—á–∞—Å: ${current.threat}/100. –≠—Ç–æ –∞–≥—Ä–µ–≥–∞—Ç –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, –∫—Ä–µ–¥–∏—Ç–æ—Ä–∫–∏, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∏ —Å–∏–≥–Ω–∞–ª–∞ –±–∞–Ω–∫—É.`
  });

  const container = document.getElementById('flags');
  container.innerHTML = "";
  for(const f of flags){
    const d = document.createElement('div');
    d.className = `flag ${f.type==='warn'?'warn':f.type==='ok'?'ok':''}`;
    d.innerHTML = `<b>${f.title}</b><div class="meta">${f.meta}</div>`;
    container.appendChild(d);
  }
}

/* =========================================================
   CHARTS (ECharts / echarts-gl)
   ========================================================= */
let charts = {};

function initCharts(){
  charts.gaugeThreat = echarts.init(document.getElementById('gaugeThreat'));
  charts.debt3d = echarts.init(document.getElementById('debt3d'));
  charts.waterfall3d = echarts.init(document.getElementById('waterfall3d'));

  charts.pfUsage3d = echarts.init(document.getElementById('pfUsage3d'));
  charts.pfSpend3d = echarts.init(document.getElementById('pfSpend3d'));
  charts.escrow3d  = echarts.init(document.getElementById('escrow3d'));
  charts.sales3d   = echarts.init(document.getElementById('sales3d'));

  charts.riskHeat3d = echarts.init(document.getElementById('riskHeat3d'));
  charts.riskRadar  = echarts.init(document.getElementById('riskRadar'));
  charts.ready3d     = echarts.init(document.getElementById('ready3d'));
  charts.timeline    = echarts.init(document.getElementById('timeline'));

  charts.dscrSurface = echarts.init(document.getElementById('dscrSurface'));
  charts.ltvSurface  = echarts.init(document.getElementById('ltvSurface'));
}

function renderGauge(){
  const v = current.threat;

  charts.gaugeThreat.setOption({
    backgroundColor: 'transparent',
    animationDuration: 900,
    series: [{
      type: 'gauge',
      startAngle: 210, endAngle: -30,
      progress: { show: true, width: 18 },
      axisLine: {
        lineStyle: {
          width: 18,
          color: [
            [0.5, '#2dd4bf'],
            [0.75,'#fbbf24'],
            [1.0, '#fb7185']
          ]
        }
      },
      pointer: { itemStyle: { color: '#eef1ff' } },
      axisTick: { show: false },
      splitLine: { length: 10, lineStyle: { color: 'rgba(255,255,255,.15)' } },
      axisLabel: { color: 'rgba(255,255,255,.55)' },
      detail: {
        valueAnimation: true,
        formatter: '{value}%',
        color: '#eef1ff',
        fontSize: 44,
        offsetCenter: [0, '35%']
      },
      title: {
        offsetCenter: [0, '70%'],
        color: 'rgba(255,255,255,.70)',
        fontWeight: 900,
        fontSize: 14
      },
      data: [{ value: v, name: 'Threat Level' }]
    }]
  });
}

function renderDebt3D(){
  const k = current.kpi;
  const data = [
    ['–ö—Ä–µ–¥–∏—Ç–æ—Ä–∫–∞ P1', k.ap_p1_mln],
    ['–ö—Ä–µ–¥–∏—Ç–æ—Ä–∫–∞ P2', k.ap_p2_mln],
    ['–ö—Ä–µ–¥–∏—Ç–æ—Ä–∫–∞ P3', k.ap_p3_mln],
    ['–ù–µ—Ü–µ–ª–µ–≤–æ–µ –ü–§',  k.pf_misuse_mln],
    ['–û—Å—Ç–∞—Ç–æ–∫ –ª–∏–º–∏—Ç–∞ –ü–§', k.pf_undrawn_mln]
  ];

  charts.debt3d.setOption({
    backgroundColor: 'transparent',
    tooltip: {},
    xAxis3D: { type:'category', data: data.map(d=>d[0]), axisLabel:{color:'#fff', interval:0} },
    yAxis3D: { type:'value', axisLabel:{color:'#fff'} },
    zAxis3D: { type:'value' },
    grid3D: {
      boxWidth: 240,
      boxDepth: 85,
      viewControl: { autoRotate: true, autoRotateSpeed: 5, damping: 0.92 },
      light: { main:{ intensity:1.25, shadow:true }, ambient:{ intensity:0.35 } }
    },
    series: [{
      type:'bar3D',
      data: data.map((d,i)=>[i, d[1], 0]),
      shading:'realistic',
      itemStyle: {
        color: (p)=>{
          const name = data[p.dataIndex][0];
          if (name.includes('–ù–µ—Ü–µ–ª–µ–≤–æ–µ')) return '#fb7185';
          if (name.includes('P1')) return '#fbbf24';
          if (name.includes('–û—Å—Ç–∞—Ç–æ–∫')) return '#60a5fa';
          return '#a78bfa';
        }
      },
      label: { show:true, formatter:(p)=> fmt.mln(p.value[1]), color:'#fff' }
    }]
  });
}

function renderWaterfall3D(){
  const k = current.kpi;

  // –≤–æ–¥–æ–ø–∞–¥ –∫–∞–∫ —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π: "—É—Å–ª–æ–≤–Ω–∞—è –≤—ã—Ä—É—á–∫–∞" = –¥–æ–≥–æ–≤–æ—Ä—ã (–ø—Ä–æ–∫—Å–∏), –º–∏–Ω—É—Å—ã = –°–ú–†/—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ/–æ—Ç–≤–ª–µ—á–µ–Ω–∏—è
  const revenueProxy = k.projects.reduce((a,p)=>a + p.contracts_mln, 0);
  const wf = [
    ['–î–æ–≥–æ–≤–æ—Ä—ã (–ø—Ä–æ–∫—Å–∏)', revenueProxy],
    ['–°–ú–†', -k.pf_cmr_mln],
    ['–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', -k.pf_admin_mln],
    ['–û—Ç–≤–ª–µ—á–µ–Ω–æ', -k.pf_divert_mln],
    ['–†–µ–∑—É–ª—å—Ç–∞—Ç', revenueProxy - k.pf_cmr_mln - k.pf_admin_mln - k.pf_divert_mln]
  ];

  charts.waterfall3d.setOption({
    backgroundColor: 'transparent',
    tooltip: {},
    xAxis3D: { type:'category', data: wf.map(d=>d[0]), axisLabel:{color:'#fff', interval:0} },
    yAxis3D: { type:'value', axisLabel:{color:'#fff'} },
    zAxis3D: { type:'value' },
    grid3D: {
      boxWidth: 260,
      boxDepth: 95,
      viewControl: { autoRotate: true, autoRotateSpeed: 4, damping: 0.92 },
      light: { main:{ intensity:1.15, shadow:true }, ambient:{ intensity:0.30 } }
    },
    series: [{
      type:'bar3D',
      data: wf.map((d,i)=>[i, d[1], 0]),
      shading:'lambert',
      itemStyle: {
        color: (p)=> (wf[p.dataIndex][1] < 0 ? '#fb7185' : '#2dd4bf')
      },
      label: { show:true, formatter:(p)=> fmt.mln(p.value[1]), color:'#fff' }
    }]
  });
}

function renderPFUsage3D(){
  const k = current.kpi;
  const data = [
    ['–í—ã–±—Ä–∞–Ω–æ', k.pf_drawn_mln],
    ['–û—Å—Ç–∞—Ç–æ–∫ –ª–∏–º–∏—Ç–∞', k.pf_undrawn_mln]
  ];
  charts.pfUsage3d.setOption({
    backgroundColor:'transparent',
    tooltip:{},
    xAxis3D:{type:'category', data:data.map(d=>d[0]), axisLabel:{color:'#fff'}},
    yAxis3D:{type:'value', axisLabel:{color:'#fff'}},
    zAxis3D:{type:'value'},
    grid3D:{
      boxWidth:200, boxDepth:80,
      viewControl:{autoRotate:true, autoRotateSpeed:5, damping:0.92},
      light:{main:{intensity:1.2, shadow:true}, ambient:{intensity:0.35}}
    },
    series:[{
      type:'bar3D',
      data:data.map((d,i)=>[i,d[1],0]),
      shading:'realistic',
      itemStyle:{color:(p)=> p.dataIndex===0 ? '#60a5fa' : '#a78bfa'},
      label:{show:true, formatter:(p)=>fmt.mln(p.value[1]), color:'#fff'}
    }]
  });
}

function renderPFSpend3D(){
  const k = current.kpi;
  const data = [
    ['–°–ú–† –ø–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é', k.pf_cmr_mln],
    ['–£–ø—Ä–∞–≤–ª–µ–Ω—á./—Ö–æ–∑.',  k.pf_admin_mln],
    ['–û—Ç–≤–ª–µ—á–µ–Ω–æ',        k.pf_divert_mln]
  ];
  charts.pfSpend3d.setOption({
    backgroundColor:'transparent',
    tooltip:{},
    xAxis3D:{type:'category', data:data.map(d=>d[0]), axisLabel:{color:'#fff', interval:0}},
    yAxis3D:{type:'value', axisLabel:{color:'#fff'}},
    zAxis3D:{type:'value'},
    grid3D:{
      boxWidth:250, boxDepth:90,
      viewControl:{autoRotate:true, autoRotateSpeed:4, damping:0.92},
      light:{main:{intensity:1.2, shadow:true}, ambient:{intensity:0.30}}
    },
    series:[{
      type:'bar3D',
      data:data.map((d,i)=>[i,d[1],0]),
      shading:'lambert',
      itemStyle:{color:(p)=>{
        if(p.dataIndex===2) return '#fb7185';
        if(p.dataIndex===1) return '#fbbf24';
        return '#2dd4bf';
      }},
      label:{show:true, formatter:(p)=>fmt.mln(p.value[1]), color:'#fff'}
    }]
  });
}

function renderEscrow3D(){
  const k = current.kpi;
  const labels = k.projects.map(p=>p.name);
  const contracts = k.projects.map(p=>p.contracts_mln);
  const escrow = k.projects.map(p=>p.escrow_mln);

  charts.escrow3d.setOption({
    backgroundColor:'transparent',
    tooltip:{},
    legend:{textStyle:{color:'rgba(255,255,255,.75)'}},
    xAxis3D:{type:'category', data:labels, axisLabel:{color:'#fff'}},
    yAxis3D:{type:'value', axisLabel:{color:'#fff'}},
    zAxis3D:{type:'value'},
    grid3D:{
      boxWidth:220, boxDepth:85,
      viewControl:{autoRotate:true, autoRotateSpeed:5, damping:0.92},
      light:{main:{intensity:1.25, shadow:true}, ambient:{intensity:0.35}}
    },
    series:[
      {
        type:'bar3D',
        name:'–î–æ–≥–æ–≤–æ—Ä—ã, –º–ª–Ω ‚ÇΩ',
        data: labels.map((_,i)=>[i, contracts[i], 0]),
        shading:'realistic',
        itemStyle:{color:'#60a5fa'},
        label:{show:true, formatter:(p)=>fmt.mln(p.value[1]), color:'#fff'}
      },
      {
        type:'bar3D',
        name:'–≠—Å–∫—Ä–æ—É, –º–ª–Ω ‚ÇΩ',
        data: labels.map((_,i)=>[i, escrow[i], 10]), // —Å–ª–µ–≥–∫–∞ —Å–º–µ—â–∞–µ–º –ø–æ z, —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞–ª–æ—Å—å
        shading:'realistic',
        itemStyle:{color:'#a78bfa'},
        label:{show:true, formatter:(p)=>fmt.mln(p.value[1]), color:'#fff'}
      }
    ]
  });
}

function renderSales3D(){
  const k = current.kpi;
  const labels = k.projects.map(p=>p.name);
  const sold = k.projects.map(p=>p.sold_m2);
  const remain = k.projects.map(p=>p.remain_m2);

  charts.sales3d.setOption({
    backgroundColor:'transparent',
    tooltip:{},
    legend:{textStyle:{color:'rgba(255,255,255,.75)'}},
    xAxis3D:{type:'category', data:labels, axisLabel:{color:'#fff'}},
    yAxis3D:{type:'value', axisLabel:{color:'#fff'}},
    zAxis3D:{type:'value'},
    grid3D:{
      boxWidth:220, boxDepth:85,
      viewControl:{autoRotate:true, autoRotateSpeed:4, damping:0.92},
      light:{main:{intensity:1.2, shadow:true}, ambient:{intensity:0.33}}
    },
    series:[
      {
        type:'bar3D',
        name:'–ü—Ä–æ–¥–∞–Ω–æ, –º¬≤',
        data: labels.map((_,i)=>[i, sold[i], 0]),
        shading:'lambert',
        itemStyle:{color:'#2dd4bf'},
        label:{show:true, formatter:(p)=>fmt.num(p.value[1])+' –º¬≤', color:'#fff'}
      },
      {
        type:'bar3D',
        name:'–û—Å—Ç–∞—Ç–æ–∫, –º¬≤',
        data: labels.map((_,i)=>[i, remain[i], 10]),
        shading:'lambert',
        itemStyle:{color:'#fbbf24'},
        label:{show:true, formatter:(p)=>fmt.num(p.value[1])+' –º¬≤', color:'#fff'}
      }
    ]
  });
}

function renderRiskHeat3D(){
  const k = current.kpi;

  // 4 –¥–æ–º–µ–Ω–∞ —Ä–∏—Å–∫–∞ (0..100)
  const liquidity = clamp(100 - k.cash_mln*6, 0, 100);
  const bank = clamp(k.pf_misuse_mln/2.0, 0, 100);
  const execution = clamp(100 - ((k.ready_mol_pct + k.ready_don_pct)/2)*2.2, 0, 100);
  const team = clamp(70 + (current.threat-70)*0.5, 0, 100);

  const data = [
    ['–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å', liquidity],
    ['–ë–∞–Ω–∫', bank],
    ['–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ', execution],
    ['–ö–æ–º–∞–Ω–¥–∞', team]
  ];

  charts.riskHeat3d.setOption({
    backgroundColor:'transparent',
    tooltip:{},
    visualMap:{
      max:100,
      inRange:{ color:['#2dd4bf','#fbbf24','#fb7185'] },
      textStyle:{color:'rgba(255,255,255,.7)'}
    },
    xAxis3D:{type:'category', data:data.map(d=>d[0]), axisLabel:{color:'#fff'}},
    yAxis3D:{type:'value', max:100, axisLabel:{color:'#fff'}},
    zAxis3D:{type:'value'},
    grid3D:{
      boxWidth:200, boxDepth:70,
      viewControl:{autoRotate:true, autoRotateSpeed:5, damping:0.92},
      light:{main:{intensity:1.25, shadow:true}, ambient:{intensity:0.30}}
    },
    series:[{
      type:'bar3D',
      data:data.map((d,i)=>[i,d[1],0]),
      shading:'lambert',
      label:{show:true, formatter:(p)=>Math.round(p.value[1])+'/100', color:'#fff'}
    }]
  });
}

function renderRiskRadar(){
  const k = current.kpi;

  const liquidity = clamp(100 - k.cash_mln*6, 0, 100);
  const bank = clamp(k.pf_misuse_mln/2.0, 0, 100);
  const execution = clamp(100 - ((k.ready_mol_pct + k.ready_don_pct)/2)*2.2, 0, 100);
  const sales = clamp(65 + (k.projects[1].remain_m2 - k.projects[1].sold_m2)/80, 0, 100); // –≥—Ä—É–±–∞—è –ø—Ä–æ–∫—Å–∏ –¥–ª—è –î–æ–Ω–µ—Ü–∫–æ–≥–æ
  const legal = clamp(60 + (k.ap_total_mln-100)/2, 0, 100);

  charts.riskRadar.setOption({
    backgroundColor:'transparent',
    tooltip:{},
    radar:{
      indicator:[
        {name:'–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å', max:100},
        {name:'–ë–∞–Ω–∫', max:100},
        {name:'–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ', max:100},
        {name:'–ü—Ä–æ–¥–∞–∂–∏', max:100},
        {name:'–Æ—Ä/–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã', max:100}
      ],
      splitNumber:5,
      axisName:{color:'rgba(255,255,255,.85)', fontWeight:800},
      splitLine:{lineStyle:{color:'rgba(255,255,255,.10)'}},
      splitArea:{areaStyle:{color:['rgba(96,165,250,.03)','rgba(251,113,133,.03)']}},
      axisLine:{lineStyle:{color:'rgba(255,255,255,.12)'}}
    },
    series:[{
      type:'radar',
      data:[{
        value:[liquidity, bank, execution, sales, legal],
        name: current.scenario.name,
        areaStyle:{opacity:0.20}
      }],
      lineStyle:{width:3},
      symbolSize:6
    }],
    legend:{textStyle:{color:'rgba(255,255,255,.75)'}}
  });
}

function renderReady3D(){
  const k = current.kpi;
  const data = [
    ['–ú–æ–ª–æ–¥—ë–∂–Ω—ã–π', k.ready_mol_pct],
    ['–î–æ–Ω–µ—Ü–∫–∏–π', k.ready_don_pct]
  ];
  charts.ready3d.setOption({
    backgroundColor:'transparent',
    tooltip:{},
    xAxis3D:{type:'category', data:data.map(d=>d[0]), axisLabel:{color:'#fff'}},
    yAxis3D:{type:'value', max:100, axisLabel:{color:'#fff'}},
    zAxis3D:{type:'value'},
    grid3D:{
      boxWidth:200, boxDepth:70,
      viewControl:{autoRotate:true, autoRotateSpeed:4, damping:0.92},
      light:{main:{intensity:1.25, shadow:true}, ambient:{intensity:0.30}}
    },
    series:[{
      type:'bar3D',
      data:data.map((d,i)=>[i,d[1],0]),
      shading:'realistic',
      itemStyle:{color:(p)=> p.value[1] < 30 ? '#fb7185' : '#2dd4bf'},
      label:{show:true, formatter:(p)=>fmt.pct(p.value[1]), color:'#fff'}
    }]
  });
}

function renderTimeline(){
  // –¢–∞–π–º–ª–∞–π–Ω PE: –∫–ª—é—á–µ–≤—ã–µ –≤–µ—Ö–∏ 30 –¥–Ω–µ–π (–º–æ–∂–µ—Ç–µ –º–µ–Ω—è—Ç—å)
  const now = new Date(BASE.meta.reportDate + "T00:00:00+03:00");
  const milestones = [
    {d: 2,  name:'–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–Ω—Ç–∏–∫—Ä–∏–∑–∏—Å-—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è', risk:'bad'},
    {d: 5,  name:'13-–Ω–µ–¥–µ–ª—å–Ω—ã–π –î–î–° + –ø–ª–∞—Ç–µ–∂–Ω—ã–π –∫–æ–º–∏—Ç–µ—Ç', risk:'bad'},
    {d: 7,  name:'–¢–û–ü-10 –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤: –º–æ—Ä–∞—Ç–æ—Ä–∏–π/–≥—Ä–∞—Ñ–∏–∫', risk:'warn'},
    {d: 10, name:'–ü–∞–∫–µ—Ç –≤ –±–∞–Ω–∫ + weekly –±–µ—Ç–æ–Ω-—Ä–µ–ø–æ—Ä—Ç', risk:'bad'},
    {d: 14, name:'–ü–ª–∞–Ω –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—É—Ç–∏ + –∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', risk:'warn'},
    {d: 21, name:'+2‚Äì3% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (—Ñ–∞–∫—Ç)', risk:'warn'},
    {d: 30, name:'+3‚Äì5% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ + —á–∞—Å—Ç–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –ü–§', risk:'ok'}
  ];

  const x = milestones.map(m => {
    const dt = new Date(now.getTime() + m.d*24*60*60*1000);
    return dt.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'});
  });
  const y = milestones.map((m,i)=> i+1);

  charts.timeline.setOption({
    backgroundColor:'transparent',
    tooltip:{formatter:(p)=> `${x[p.dataIndex]} ‚Ä¢ <b>${milestones[p.dataIndex].name}</b>`},
    grid:{left:40,right:20,top:30,bottom:40},
    xAxis:{
      type:'category',
      data:x,
      axisLabel:{color:'rgba(255,255,255,.75)'},
      axisLine:{lineStyle:{color:'rgba(255,255,255,.12)'}}
    },
    yAxis:{
      type:'value',
      min:0, max: milestones.length+1,
      axisLabel:{show:false},
      splitLine:{show:false}
    },
    series:[{
      type:'line',
      data:y,
      symbol:'circle',
      symbolSize:12,
      lineStyle:{width:3},
      itemStyle:{
        color:(p)=>{
          const r = milestones[p.dataIndex].risk;
          if (r==='bad') return '#fb7185';
          if (r==='warn') return '#fbbf24';
          return '#2dd4bf';
        }
      },
      label:{
        show:true,
        formatter:(p)=>milestones[p.dataIndex].name,
        position:'top',
        color:'rgba(255,255,255,.85)',
        fontWeight:800
      }
    }]
  });
}

function renderDSCRSurface(){
  // DSCR sensitivity surface (proxy):
  // X: –ø–∞–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ (0..30%)
  // Y: —Ä–æ—Å—Ç —Å—Ç–∞–≤–∫–∏ (0..4 –ø.–ø.)
  // Z: DSCR proxy = 1.25 - 0.012*x - 0.08*y - threatAdjust
  const threatAdj = (current.threat - 70) / 300; // 70->0, 100->0.1

  const xVals = [];
  for(let i=0;i<=30;i+=3) xVals.push(i);
  const yVals = [];
  for(let j=0;j<=4;j+=0.5) yVals.push(j);

  const data = [];
  for(let yi=0; yi<yVals.length; yi++){
    for(let xi=0; xi<xVals.length; xi++){
      const x = xVals[xi];
      const y = yVals[yi];
      const z = clamp(1.25 - 0.012*x - 0.08*y - threatAdj, 0.4, 1.6);
      data.push([x, y, z]);
    }
  }

  charts.dscrSurface.setOption({
    backgroundColor:'transparent',
    tooltip:{formatter:(p)=> `Sales -${p.value[0]}%<br/>Rate +${p.value[1]} –ø.–ø.<br/><b>DSCR‚âà ${p.value[2].toFixed(2)}</b>`},
    visualMap:{
      min:0.6, max:1.4,
      inRange:{ color:['#fb7185','#fbbf24','#2dd4bf'] },
      textStyle:{color:'rgba(255,255,255,.7)'}
    },
    xAxis3D:{type:'value', name:'–ü–∞–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂, %', axisLabel:{color:'#fff'}, nameTextStyle:{color:'rgba(255,255,255,.75)'}},
    yAxis3D:{type:'value', name:'–†–æ—Å—Ç —Å—Ç–∞–≤–∫–∏, –ø.–ø.', axisLabel:{color:'#fff'}, nameTextStyle:{color:'rgba(255,255,255,.75)'}},
    zAxis3D:{type:'value', name:'DSCR (proxy)', axisLabel:{color:'#fff'}, nameTextStyle:{color:'rgba(255,255,255,.75)'}},
    grid3D:{
      viewControl:{autoRotate:true, autoRotateSpeed:4, damping:0.92},
      light:{main:{intensity:1.2, shadow:true}, ambient:{intensity:0.25}},
      boxWidth: 240,
      boxDepth: 170
    },
    series:[{
      type:'surface',
      wireframe:{show:false},
      shading:'realistic',
      data: data
    }]
  });
}

function renderLTVSurface(){
  // LTV matrix/surface (proxy):
  // X: –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å (20..60%)
  // Y: —Ç–µ–º–ø –ø—Ä–æ–¥–∞–∂ (–∏–Ω–¥–µ–∫—Å 0.7..1.2)
  // Z: LTV proxy = 0.78 - 0.006*(ready-30) - 0.18*(salesIdx-1) + threat*0.001
  const threat = current.threat;

  const ready = [];
  for(let r=20;r<=60;r+=4) ready.push(r);
  const salesIdx = [];
  for(let s=0.7;s<=1.2;s+=0.05) salesIdx.push(Number(s.toFixed(2)));

  const data = [];
  for(let yi=0; yi<salesIdx.length; yi++){
    for(let xi=0; xi<ready.length; xi++){
      const r = ready[xi];
      const s = salesIdx[yi];
      const z = clamp(0.78 - 0.006*(r-30) - 0.18*(s-1) + threat*0.001, 0.45, 0.95);
      data.push([r, s, z]);
    }
  }

  charts.ltvSurface.setOption({
    backgroundColor:'transparent',
    tooltip:{formatter:(p)=> `–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å ${p.value[0]}%<br/>SalesIdx ${p.value[1]}<br/><b>LTV‚âà ${(p.value[2]*100).toFixed(1)}%</b>`},
    visualMap:{
      min:0.50, max:0.90,
      inRange:{ color:['#2dd4bf','#fbbf24','#fb7185'] }, // –Ω–∏–∂–µ = –ª—É—á—à–µ, –≤—ã—à–µ = —Ö—É–∂–µ (–Ω–æ –≤–∏–∑—É–∞–ª—å–Ω–æ –∑–¥–µ—Å—å –Ω–∞–æ–±–æ—Ä–æ—Ç) ‚Äî –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      textStyle:{color:'rgba(255,255,255,.7)'}
    },
    xAxis3D:{type:'value', name:'–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å, %', axisLabel:{color:'#fff'}, nameTextStyle:{color:'rgba(255,255,255,.75)'}},
    yAxis3D:{type:'value', name:'Sales Index', axisLabel:{color:'#fff'}, nameTextStyle:{color:'rgba(255,255,255,.75)'}},
    zAxis3D:{type:'value', name:'LTV (proxy)', axisLabel:{color:'#fff'}, nameTextStyle:{color:'rgba(255,255,255,.75)'}},
    grid3D:{
      viewControl:{autoRotate:true, autoRotateSpeed:4.5, damping:0.92},
      light:{main:{intensity:1.2, shadow:true}, ambient:{intensity:0.25}},
      boxWidth: 240,
      boxDepth: 170
    },
    series:[{
      type:'surface',
      wireframe:{show:false},
      shading:'realistic',
      data: data
    }]
  });
}

function renderAllCharts(){
  renderGauge();
  renderDebt3D();
  renderWaterfall3D();

  renderPFUsage3D();
  renderPFSpend3D();
  renderEscrow3D();
  renderSales3D();

  renderRiskHeat3D();
  renderRiskRadar();
  renderReady3D();
  renderTimeline();

  renderDSCRSurface();
  renderLTVSurface();
}

function resizeAll(){
  for(const k in charts){
    try{ charts[k].resize(); }catch(e){}
  }
}
window.addEventListener('resize', resizeAll);

/* =========================================================
   BOOT
   ========================================================= */
initCharts();
renderKpis();
renderFlags();
renderAllCharts();
</script>

</body>
</html>
